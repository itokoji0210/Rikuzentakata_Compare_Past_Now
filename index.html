<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>YouTube 比較（中央スライダー：左=過去／右=今／デモ往復＋注釈ガイド）</title>
<style>
  :root{
    --split:50%;
    --fade:1;                 /* 1=今(上100%) / 0=過去(上0%) */
    --accent:#2b7cff;
    --radius:12px;
    --timeline:#2b7cff;
    --timeline-bg:#1b1f2a;
    --timeline-border:#2a3142;
    --compare-bg:#2a2f3d;
  }
  body{margin:0;background:#0f1115;color:#e8e8e8;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif}
  header{padding:14px 16px 6px}
  h1{font-size:clamp(16px,2.6vw,20px);margin:0 0 6px}
  p{margin:0;font-size:12px;opacity:.85}
  .wrap{max-width:1200px;margin:10px auto 18px;padding:0 12px}

  /* プレイヤー */
  .compare{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:var(--radius);overflow:hidden}
  .layer{position:absolute;inset:0}
  .ytbox{position:absolute;inset:0}

  /* 表示ロジック
     - スライダー：上(今)を「右側だけ」見せる → 左=過去、右=今
     - フェード：上(今)の不透明度で比較（中央バー非表示）
  */
  .mode-slider .top{opacity:1;clip-path:inset(0 0 0 var(--split))}
  .mode-fade   .top{opacity:var(--fade);transition:opacity .06s linear;clip-path:inset(0 0 0 0)}

  /* ラベル帯 & ミニフェーダー（上） */
  .topband{position:absolute;left:0;right:0;top:0;z-index:6;display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px 12px;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,.05))}
  .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.4)}
  .dot{width:8px;height:8px;border-radius:50%;background:#fff;opacity:.9}
  .past .dot{background:#9ec1ff}.now .dot{background:#9dffb0}
  .sub{opacity:.9}
  .mode-badge{padding:6px 10px;border-radius:999px;background:#1b1f2a;border:1px solid #2a3142;font-size:12px}
  .fade-mini{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#1b1f2a;border:1px solid #2a3142}
  .fade-mini input{width:140px;height:6px}

  /* クリックで停止しないためのクリックガード */
  .clickshield{position:absolute;inset:0;z-index:5;pointer-events:auto}

  /* 中央スライダー（デモ往復あり／フェード時は非表示） */
  .slider-rail{position:absolute;inset:0;pointer-events:none;z-index:7}
  .split-line{position:absolute;top:0;bottom:0;left:var(--split);transform:translateX(-50%);width:2px;background:rgba(255,255,255,.92)}
  .handle{position:absolute;top:50%;left:var(--split);transform:translate(-50%,-50%);width:24px;height:24px;border-radius:50%;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.35);pointer-events:auto;cursor:ew-resize}
  .mode-fade .slider-rail{display:none}

  /* ローディング */
  .loading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.6));z-index:8;opacity:0;visibility:hidden;transition:.2s}
  .loading.show{opacity:1;visibility:visible}
  .spinner{width:36px;height:36px;border:3px solid #ffffff40;border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* タイムライン（青＋バッファ） */
  .timeline{display:flex;align-items:center;gap:8px;margin:8px 0 2px;font-size:12px}
  .time{min-width:72px;text-align:center;font-variant-numeric:tabular-nums}
  .scrub-wrap{position:relative;flex:1 1 auto}
  .buffer{position:absolute;left:0;right:0;top:50%;height:6px;transform:translateY(-50%);background:var(--timeline-bg);border:1px solid var(--timeline-border);border-radius:999px;overflow:hidden}
  .buffer>.bar{height:100%;width:0%;background:linear-gradient(90deg,#375a9f,#2b7cff)}
  .scrub{-webkit-appearance:none;appearance:none;width:100%;height:6px;background:transparent;position:relative}
  .scrub::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#fff;border:1px solid #00000030}
  .scrub::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:#fff;border:1px solid #00000030}

  /* 操作群 */
  .controls{display:flex;flex-wrap:wrap;gap:8px 10px;align-items:center;padding:10px 2px}
  .controls button,.controls select,.controls input[type="range"]{background:#1b1f2a;color:#e8e8e8;border:1px solid #2a3142;border-radius:8px;padding:8px 10px;font-size:14px}
  .range{flex:1 1 220px;display:flex;align-items:center;gap:8px}
  #range{-webkit-appearance:none;appearance:none;width:100%;height:6px;background:var(--compare-bg);border-radius:999px}
  #range::-webkit-slider-thumb,#range::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:#fff;border:1px solid #00000030}

  /* 全画面時の下部フェーダー常時表示 */
  .fade-bottom{position:absolute;left:0;right:0;bottom:0;z-index:9;display:none;align-items:center;gap:10px;padding:10px 12px;background:linear-gradient(0deg,rgba(0,0,0,.65),rgba(0,0,0,0))}
  .fade-bottom input{flex:1 1 auto;height:6px}
  body.fs .fade-bottom{display:flex;}

  /* 初回注釈ガイド */
  .guide{
    position:absolute;inset:0;
    display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.55);
    color:#fff;z-index:20;
    opacity:0;visibility:hidden;transition:.3s;
  }
  .guide.show{opacity:1;visibility:visible;}
  .guide .box{
    background:rgba(0,0,0,.8);
    padding:16px 20px;border-radius:12px;
    max-width:92%;text-align:center;
    font-size:14px;line-height:1.6;
    box-shadow:0 8px 30px rgba(0,0,0,.35);
  }
  .guide .box h3{margin:0 0 8px;font-size:16px;}
  .guide .bullet{margin:.25em 0}
  .guide button{
    margin-top:12px;padding:6px 12px;
    border:1px solid #2a3142;border-radius:8px;
    background:#1b1f2a;color:#fff;cursor:pointer;
  }
</style>
</head>
<body>
  <header class="wrap">
    <h1>過去 × 今｜YouTube 比較（中央スライダー：左=過去／右=今）</h1>
    <p>デフォルトは中央スライダー（自動デモあり）。必要に応じてフェードに切替可能。再生・シークは2本を同期します。</p>
  </header>

  <main class="wrap">
    <section id="compare" class="compare mode-slider" aria-label="YouTube比較">
      <!-- 上部ラベル＆ミニフェーダー（フェード時の補助） -->
      <div class="topband">
        <div class="tag past"><span class="dot"></span><span>左：過去</span><span class="sub" id="stampPast">YouTube</span></div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="mode-badge" id="modeBadge">モード：スライダー</div>
          <div class="fade-mini" id="fadeMini" style="display:none;">
            <span>昔</span>
            <input id="fadeInline" type="range" min="0" max="100" value="100" step="1" aria-label="フェード（昔↔今）">
            <span>今</span>
          </div>
        </div>
        <div class="tag now"><span class="dot"></span><span>右：今</span><span class="sub" id="stampNow">YouTube</span></div>
      </div>

      <!-- 下：昔 -->
      <div class="layer bottom"><div id="pastBox" class="ytbox"></div></div>
      <!-- 上：今（スライダーでは右側／フェードではopacity） -->
      <div class="layer top" id="topLayer"><div id="nowBox" class="ytbox"></div></div>

      <!-- クリックガード（停止防止） -->
      <div class="clickshield" id="clickshield"></div>

      <!-- 中央スライダー（デモ往復あり） -->
      <div class="slider-rail" aria-hidden="true">
        <div class="split-line" id="splitLine"></div>
        <div class="handle" id="handle" tabindex="0" role="slider" aria-valuemin="0" aria-valuemax="100" aria-valuenow="50" aria-label="比較位置"></div>
      </div>

      <!-- ローディング -->
      <div class="loading" id="loading"><div class="spinner"></div></div>

      <!-- 全画面下部フェーダー（常時） -->
      <div class="fade-bottom" id="fadeBottom">
        <span>昔</span>
        <input id="fadeBottomRange" type="range" min="0" max="100" value="100" step="1" aria-label="フェード（昔↔今）全画面用">
        <span>今</span>
      </div>

      <!-- 初回注釈ガイド -->
      <div class="guide" id="guide">
        <div class="box">
          <h3>操作ガイド</h3>
          <div class="bullet">🖱️ スライダーを<strong>ドラッグ</strong>して「過去 ↔ 今」を比較できます。</div>
          <div class="bullet">🔄 <strong>モード切替</strong>で、フェード比較にも変更できます。</div>
          <div class="bullet">▶️ <strong>再生</strong>を押すと、2本のYouTubeが同期再生されます。</div>
          <button id="guideClose">OK</button>
        </div>
      </div>
    </section>

    <!-- タイムライン（青） -->
    <section class="timeline" aria-label="タイムライン">
      <div class="time" id="timeCur">00:00</div>
      <div class="scrub-wrap">
        <div class="buffer"><div class="bar" id="bufferBar"></div></div>
        <input id="scrub" class="scrub" type="range" min="0" max="1" step="0.0001" value="0" aria-label="再生位置">
      </div>
      <div class="time" id="timeDur">--:--</div>
    </section>

    <!-- 操作群（明示UI） -->
    <section class="controls" aria-label="再生コントロール">
      <button id="playBtn"   type="button" title="再生">▶︎ 再生</button>
      <button id="pauseBtn"  type="button" title="停止">⏸ 停止</button>
      <button id="revBtn"    type="button" title="逆再生トグル">↶ 逆再生</button>
      <button id="stepBack"  type="button" title="コマ戻し">⟲ コマ戻し</button>
      <button id="stepFwd"   type="button" title="コマ送り">⟳ コマ送り</button>
      <button id="restartBtn"type="button" title="先頭">↺ 先頭</button>
      <button id="muteBtn"   type="button" title="ミュート">🔇 ミュート</button>

      <select id="speedSel" title="再生速度">
        <option value="0.25">0.25×</option>
        <option value="0.5">0.5×</option>
        <option value="1" selected>1×</option>
        <option value="1.5">1.5×</option>
        <option value="2">2×</option>
      </select>

      <div class="range">
        <span id="rangeLabel">比較（スライダー）：</span>
        <input id="range" type="range" min="0" max="100" value="50" step="0.1" aria-label="比較位置スライダー">
      </div>

      <button id="modeBtn" type="button" title="スライダー／フェード切替">モード切替</button>
      <button id="fsBtn" type="button" title="フルスクリーン">⛶ 全画面</button>
    </section>
  </main>

<script>
/* ====== 設定：動画ID（差し替え可） ====== */
const YT_PAST_ID = 'twUhcvIGlpY';   // 昔（左）
const YT_NOW_ID  = 'FON4lib3hgQ';   // 今（右）

/* ====== 参照 ====== */
const compare   = document.getElementById('compare');
const handle    = document.getElementById('handle');
const range     = document.getElementById('range');
const modeBtn   = document.getElementById('modeBtn');
const modeBadge = document.getElementById('modeBadge');
const fadeMini  = document.getElementById('fadeMini');
const fadeInline= document.getElementById('fadeInline');
const fadeBottomRange = document.getElementById('fadeBottomRange');
const loading   = document.getElementById('loading');
const timeCur   = document.getElementById('timeCur');
const timeDur   = document.getElementById('timeDur');
const scrub     = document.getElementById('scrub');
const bufferBar = document.getElementById('bufferBar');
const playBtn   = document.getElementById('playBtn');
const pauseBtn  = document.getElementById('pauseBtn');
const restartBtn= document.getElementById('restartBtn');
const muteBtn   = document.getElementById('muteBtn');
const speedSel  = document.getElementById('speedSel');
const fsBtn     = document.getElementById('fsBtn');
const clickshield= document.getElementById('clickshield');
const fadeBottom = document.getElementById('fadeBottom');

const guide = document.getElementById('guide');
const guideClose = document.getElementById('guideClose');

let mode='slider'; // 既定：スライダー
let split=50;
function setSplit(p){ split=Math.max(0,Math.min(100,p)); document.documentElement.style.setProperty('--split', split.toFixed(2)+'%'); handle.setAttribute('aria-valuenow', split.toFixed(1)); range.value=split; }
function setFade(p){ const v=Math.max(0,Math.min(100,p))/100; document.documentElement.style.setProperty('--fade', v.toFixed(3)); if(fadeInline) fadeInline.value=Math.round(p); if(fadeBottomRange) fadeBottomRange.value=Math.round(p); }
setSplit(50); setFade(100);

/* ====== モード切替 ====== */
function applyMode(m){
  mode=m;
  compare.classList.toggle('mode-fade',   m==='fade');
  compare.classList.toggle('mode-slider', m==='slider');
  modeBadge.textContent='モード：'+(m==='fade'?'フェード':'スライダー');
  document.getElementById('rangeLabel').textContent = (m==='fade'?'フェード：':'比較（スライダー）：');
  fadeMini.style.display = (m==='fade') ? 'flex' : 'none';
}
applyMode('slider');
modeBtn.addEventListener('click', ()=> applyMode(mode==='fade'?'slider':'fade'));
if(fadeInline)      fadeInline.addEventListener('input', e=> setFade(parseFloat(e.target.value)));
if(fadeBottomRange) fadeBottomRange.addEventListener('input', e=> setFade(parseFloat(e.target.value)));

/* ====== 中央スライダー（クリック含む） ====== */
function clientXToPercent(clientX){
  const r=compare.getBoundingClientRect(); return (clientX-r.left)/r.width*100;
}
let dragging=false;
function startDrag(){ dragging=true; document.body.style.cursor='ew-resize'; stopDemo(); }
function moveDrag(e){
  if(!dragging) return;
  const x = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
  mode==='slider' ? setSplit(clientXToPercent(x)) : setFade(clientXToPercent(x));
}
function endDrag(){ dragging=false; document.body.style.cursor=''; }
handle.addEventListener('mousedown', startDrag);
window.addEventListener('mousemove', moveDrag, {passive:true});
window.addEventListener('mouseup', endDrag);
handle.addEventListener('touchstart', e=>{e.preventDefault();startDrag();},{passive:false});
window.addEventListener('touchmove', moveDrag, {passive:false});
window.addEventListener('touchend', endDrag);
compare.addEventListener('pointerdown', e=>{
  if(e.target!==handle){ const p=clientXToPercent(e.clientX); mode==='slider'?setSplit(p):setFade(p); stopDemo(); }
});
range.addEventListener('input', e=>{ const p=parseFloat(e.target.value); mode==='slider'?setSplit(p):setFade(p); stopDemo(); });

/* ====== デモ往復（再生ボタンを押すまで） ====== */
let demoRAF=null, demoDir=1, demoStart=null;
function demoStep(ts){
  if(!demoStart) demoStart=ts;
  const dur=2600; // 2.6sで片道
  const t=(ts-demoStart)%dur;
  const k=t/dur; // 0..1
  // 20%⇔80%を往復
  const a=20, b=80;
  const val = demoDir>0 ? (a + (b-a)*k) : (b - (b-a)*k);
  setSplit(val);
  if(k>=0.999){ demoDir*=-1; demoStart=ts; }
  demoRAF=requestAnimationFrame(demoStep);
}
function startDemo(){ if(!demoRAF) demoRAF=requestAnimationFrame(demoStep); }
function stopDemo(){ if(demoRAF){ cancelAnimationFrame(demoRAF); demoRAF=null; } }
startDemo();

/* ====== クリックで停止しない ====== */
clickshield.addEventListener('click', ()=>{}); // no-op

/* ====== フルスクリーン ====== */
document.addEventListener('fullscreenchange', ()=>{ document.body.classList.toggle('fs', !!document.fullscreenElement); });
fsBtn.addEventListener('click', async ()=>{ if(!document.fullscreenElement){ try{ await compare.requestFullscreen(); }catch(e){} } else { await document.exitFullscreen(); } });

/* ====== YouTube IFrame API ====== */
let pastPlayer, nowPlayer;
let readyPast=false, readyNow=false;
let rafId=null, tickTimer=null;
let reverseRAF=null;
const SYNC_EPS=0.20;
const PREBUFFER_FRAC=0.02;

function showLoading(){ loading.classList.add('show'); }
function hideLoading(){ loading.classList.remove('show'); }

/* 時刻UI */
function formatTime(sec){
  if(!isFinite(sec)) return '--:--';
  const s=Math.max(0,Math.floor(sec)), h=Math.floor(s/3600), m=Math.floor((s%3600)/60), r=s%60;
  return h>0 ? `${h}:${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}` : `${m}:${String(r).padStart(2,'0')}`;
}
function updateDuration(){
  const d=Math.min(pastPlayer?.getDuration()||0, nowPlayer?.getDuration()||0);
  if(d>0){ timeDur.textContent=formatTime(d); scrub.max=d; }
}
function updateTimeUI(){
  const t=Math.min(pastPlayer?.getCurrentTime()||0, nowPlayer?.getCurrentTime()||0);
  const d=Math.min(pastPlayer?.getDuration()||0, nowPlayer?.getDuration()||0);
  timeCur.textContent=formatTime(t);
  if(d>0){ scrub.value=t; }
  const frac = nowPlayer?.getVideoLoadedFraction ? nowPlayer.getVideoLoadedFraction() : 0;
  bufferBar.style.width = Math.max(0, Math.min(100, frac*100)) + '%';
}
function seekBoth(t){
  const d=Math.min(pastPlayer?.getDuration()||0, nowPlayer?.getDuration()||0);
  const clamped=Math.max(0, Math.min(d||0, t));
  pastPlayer?.seekTo(clamped, true);
  nowPlayer?.seekTo(clamped, true);
  updateTimeUI();
}

/* 同期ループ（再生中のみ吸着） */
function syncTick(){
  if(!(readyPast&&readyNow)) return;
  const tp=pastPlayer.getCurrentTime(), tn=nowPlayer.getCurrentTime();
  const dp=Math.abs(tp-tn);
  const np=nowPlayer.getPlayerState(), pp=pastPlayer.getPlayerState();
  if(np===1 || pp===1){
    if(dp>SYNC_EPS){ pastPlayer.seekTo(tn, true); }
  }
  updateTimeUI();
  rafId=requestAnimationFrame(syncTick);
}
function startSync(){ if(!rafId){ rafId=requestAnimationFrame(syncTick); } if(!tickTimer){ tickTimer=setInterval(updateTimeUI,200); } }
function stopSync(){ if(rafId){ cancelAnimationFrame(rafId); rafId=null; } if(tickTimer){ clearInterval(tickTimer); tickTimer=null; } }

/* 再生・停止・速度・コマ送り/戻し・逆再生 */
function playBoth(){
  if(!(readyPast&&readyNow)) return;
  pastPlayer.playVideo(); nowPlayer.playVideo();
  stopDemo(); // 再生開始でデモ終了
}
function pauseBoth(){ pastPlayer?.pauseVideo(); nowPlayer?.pauseVideo(); }
playBtn.addEventListener('click', ()=> playBoth());
pauseBtn.addEventListener('click', ()=> pauseBoth());
restartBtn.addEventListener('click', ()=> seekBoth(0));
muteBtn.addEventListener('click', ()=>{
  const muted = nowPlayer?.isMuted?.();
  if(muted){ nowPlayer.unMute(); pastPlayer.unMute(); muteBtn.textContent='🔇 ミュート'; }
  else{ nowPlayer.mute(); pastPlayer.mute(); muteBtn.textContent='🔊 ミュート解除'; }
});
speedSel.addEventListener('change', ()=>{
  const r=parseFloat(speedSel.value)||1;
  nowPlayer?.setPlaybackRate?.(r);
  pastPlayer?.setPlaybackRate?.(r);
});
scrub.addEventListener('input', e=> seekBoth(parseFloat(e.target.value)));

/* コマ送り/戻し（1/30秒刻み） */
const frameSec=1/30;
document.getElementById('stepFwd').addEventListener('click', ()=>{ pauseBoth(); seekBoth((nowPlayer?.getCurrentTime()||0)+frameSec); });
document.getElementById('stepBack').addEventListener('click', ()=>{ pauseBoth(); seekBoth((nowPlayer?.getCurrentTime()||0)-frameSec); });

/* 逆再生（簡易） */
function reverseLoop(){
  const rate=parseFloat(speedSel.value)||1;
  const step=(1/60)*rate;
  const t=Math.max(0,(nowPlayer?.getCurrentTime()||0)-step);
  seekBoth(t);
  if(t<=0){ stopReverse(); pauseBoth(); return; }
  reverseRAF=requestAnimationFrame(reverseLoop);
}
function startReverse(){ pauseBoth(); if(!reverseRAF){ reverseRAF=requestAnimationFrame(reverseLoop); document.getElementById('revBtn').textContent='⏹ 逆再生停止'; stopDemo(); } }
function stopReverse(){ if(reverseRAF){ cancelAnimationFrame(reverseRAF); reverseRAF=null; document.getElementById('revBtn').textContent='↶ 逆再生'; } }
document.getElementById('revBtn').addEventListener('click', ()=> reverseRAF?stopReverse():startReverse());

/* 再生前バッファ待機（読み込み時間差の緩和） */
async function waitPrebuffer(th=PREBUFFER_FRAC, timeout=6000){
  const t0=performance.now();
  return new Promise(res=>{
    function check(){
      const okPast = (pastPlayer?.getVideoLoadedFraction?.()||0) >= th;
      const okNow  = (nowPlayer ?.getVideoLoadedFraction?.()||0) >= th;
      if(okPast && okNow) return res(true);
      if(performance.now()-t0>timeout) return res(false);
      setTimeout(check, 100);
    }
    check();
  });
}
playBtn.addEventListener('click', async ()=>{
  if(!(readyPast&&readyNow)) return;
  showLoading();
  await waitPrebuffer(PREBUFFER_FRAC, 6000);
  const t = Math.min(pastPlayer.getCurrentTime()||0, nowPlayer.getCurrentTime()||0);
  seekBoth(t);
  hideLoading();
});

/* YouTube IFrame API 読み込み＆プレイヤー生成 */
const tag=document.createElement('script');
tag.src="https://www.youtube.com/iframe_api";
document.head.appendChild(tag);
window.onYouTubeIframeAPIReady = function(){
  const playerVars = { playsinline:1, controls:0, rel:0, fs:0, iv_load_policy:3, disablekb:1, origin: location.origin };
  showLoading();
  pastPlayer = new YT.Player('pastBox', {
    videoId: YT_PAST_ID, width:'100%', height:'100%', playerVars,
    events:{ onReady: e=>{ readyPast=true; e.target.mute(); checkReady(); }, onStateChange: onStateChange }
  });
  nowPlayer = new YT.Player('nowBox', {
    videoId: YT_NOW_ID, width:'100%', height:'100%', playerVars,
    events:{ onReady: e=>{ readyNow=true; e.target.mute(); checkReady(); }, onStateChange: onStateChange }
  });
};
function onStateChange(ev){
  const s=ev.data;
  if(s===3){ showLoading(); }
  if(s===1||s===2||s===5){ hideLoading(); }
  if(s===0){ pauseBoth(); }
}
function checkReady(){
  if(readyPast && readyNow){
    hideLoading();
    updateDuration();
    updateTimeUI();
    startSync();
    // 初回ガイド（localStorageで1度だけ表示）
    if(!localStorage.getItem('ytCompareGuideSeen')){
      guide.classList.add('show');
    }
  }
}

/* 初回注釈ガイド：閉じるで記録＆デモ停止 */
function hideGuide(){
  guide.classList.remove('show');
  localStorage.setItem('ytCompareGuideSeen','1');
  stopDemo();
}
guideClose.addEventListener('click', hideGuide);

</script>
</body>
</html>
